<!doctype html>
<html lang="ja">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Aya and Koki Wedding After Party</title>
  <style>
    /* ==================== CSSå¤‰æ•°ã§ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆçµ±ä¸€ç®¡ç† ==================== */
    :root {
      /* AYAæ¨ã— - Dreamy Pop & Kawaii Electric */
      --aya1: #FF1493;    /* ãƒã‚ªãƒ³ãƒ”ãƒ³ã‚¯ */
      --aya2: #FFD6E0;    /* ãƒŸãƒ«ã‚­ãƒ¼ãƒ”ãƒ³ã‚¯ */
      --aya3: #E5C6FF;    /* ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼ */
      --aya4: #FFF9C4;    /* ã‚½ãƒ•ãƒˆã‚¤ã‚¨ãƒ­ãƒ¼ */
      --aya5: #FF4F81;    /* é®®ã‚„ã‹ãƒ”ãƒ³ã‚¯ */
      --aya-glow: rgba(255, 20, 147, 0.8);
      --aya-shadow: rgba(255, 79, 129, 0.6);
      
      /* KOKIæ¨ã— - Cyber Persona & Electric Blue */
      --koki1: #001F54;   /* ãƒ‡ã‚£ãƒ¼ãƒ—ãƒã‚¤ãƒ“ãƒ¼ */
      --koki2: #0059FF;   /* ã‚¯ãƒªã‚¢ãƒ–ãƒ«ãƒ¼ */
      --koki3: #00F0FF;   /* ã‚µã‚¤ã‚¢ãƒ³ãƒ©ã‚¤ãƒˆ */
      --koki4: #7A00FF;   /* ãƒ‘ãƒ¼ãƒ—ãƒ«ã‚°ãƒªãƒƒãƒ */
      --koki5: #E0F7FA;   /* ãƒ¡ã‚¿ãƒ«ãƒ›ãƒ¯ã‚¤ãƒˆ */
      --koki-glow: rgba(0, 240, 255, 0.8);
      --koki-shadow: rgba(0, 89, 255, 0.6);
      
      /* UIå…±é€š */
      --glass-bg: rgba(0, 0, 0, 0.5);
      --glass-border: rgba(255, 255, 255, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      box-sizing: border-box;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Yu Gothic', sans-serif;
      touch-action: none;
      position: fixed;
    }

    html, body {
      height: 100%;
    }

    /* ==================== ãƒ¡ã‚¤ãƒ³èƒŒæ™¯ã‚¨ãƒªã‚¢ï¼ˆ3å±¤æ§‹é€ ï¼‰ ==================== */
    #light-area {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transition: background 0.6s ease, filter 0.3s ease;
      overflow: hidden;
    }

    /* ç™ºå…‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
    #light-area::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 30% 40%, rgba(255,255,255,0.35), transparent 60%),
                  radial-gradient(circle at 70% 70%, rgba(255,255,255,0.25), transparent 70%),
                  radial-gradient(circle at 50% 20%, rgba(255,255,255,0.2), transparent 50%);
      mix-blend-mode: overlay;
      animation: shimmer 6s ease-in-out infinite alternate;
      pointer-events: none;
      z-index: 1;
    }

    /* å¾®å…‰ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
    #light-area::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 15% 25%, rgba(255,255,255,0.15) 0%, transparent 3%),
        radial-gradient(circle at 85% 35%, rgba(255,255,255,0.12) 0%, transparent 3%),
        radial-gradient(circle at 45% 65%, rgba(255,255,255,0.18) 0%, transparent 3%),
        radial-gradient(circle at 25% 85%, rgba(255,255,255,0.14) 0%, transparent 3%),
        radial-gradient(circle at 65% 15%, rgba(255,255,255,0.16) 0%, transparent 3%);
      background-size: 100% 100%;
      animation: twinkle 8s ease-in-out infinite;
      pointer-events: none;
      z-index: 1;
    }

    @keyframes shimmer {
      0%, 100% { 
        opacity: 0.6;
        transform: scale(1);
      }
      50% { 
        opacity: 1;
        transform: scale(1.05);
      }
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.5; }
      25% { opacity: 0.8; }
      50% { opacity: 0.6; }
      75% { opacity: 0.9; }
    }

    #particles-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2;
    }

    /* ==================== ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚¹ãƒãƒƒãƒˆãƒ©ã‚¤ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ==================== */
    #effects-layer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 3;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #effects-layer.active {
      opacity: 1;
    }

    .laser-sweep {
      position: absolute;
      top: 0;
      left: 0;
      width: 300%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255,255,255,0.6) 48%, 
        rgba(255,255,255,0.8) 50%, 
        rgba(255,255,255,0.6) 52%, 
        transparent 100%);
      animation: laser-sweep 2.5s linear infinite;
      mix-blend-mode: screen;
    }

    @keyframes laser-sweep {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(33.33%); }
    }

    .spotlight {
      position: absolute;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,255,255,0.4), transparent 70%);
      animation: spotlight-move 8s ease-in-out infinite;
      mix-blend-mode: overlay;
    }

    @keyframes spotlight-move {
      0%, 100% { 
        left: 10%; 
        top: 20%;
        transform: scale(1);
      }
      25% { 
        left: 70%; 
        top: 60%;
        transform: scale(1.3);
      }
      50% { 
        left: 30%; 
        top: 70%;
        transform: scale(0.9);
      }
      75% { 
        left: 80%; 
        top: 30%;
        transform: scale(1.2);
      }
    }

    /* ==================== ç¨²å¦»ãƒ»å…‰ç·šã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ ==================== */
    #lightning-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 4;
    }

    /* ==================== ãƒ˜ãƒƒãƒ€ãƒ¼ ==================== */
    #header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 20px;
      text-align: center;
      z-index: 10;
      pointer-events: none;
    }

    #title {
      font-size: 20px;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 25px rgba(0,0,0,0.95), 0 2px 8px rgba(0,0,0,0.8), 0 0 15px rgba(255,255,255,0.6);
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    #subtitle {
      font-size: 14px;
      color: rgba(255,255,255,0.98);
      text-shadow: 0 0 15px rgba(0,0,0,0.95), 0 1px 5px rgba(0,0,0,0.8), 0 0 10px rgba(255,255,255,0.5);
      font-weight: 600;
    }

    /* ==================== çŠ¶æ…‹è¡¨ç¤ºãƒãƒ¼ ==================== */
    #status-bar {
      position: fixed;
      bottom: 180px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 2px solid var(--glass-border);
      border-radius: 30px;
      padding: 12px 28px;
      z-index: 9;
      pointer-events: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 80px rgba(255, 255, 255, 0.2);
      transition: all 0.6s ease;
    }

    #status-text {
      font-size: 16px;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 25px rgba(255, 255, 255, 0.9), 0 2px 5px rgba(0,0,0,0.8);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* ==================== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ ==================== */
    #controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      z-index: 10;
    }

    .control-btn {
      padding: 22px 24px;
      border: none;
      border-radius: 20px;
      font-size: 16px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6), 0 0 50px rgba(255,255,255,0.25);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.4);
      min-height: 70px;
    }

    .control-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.6);
      transform: translate(-50%, -50%);
      transition: width 0.6s ease, height 0.6s ease;
    }

    .control-btn:active {
      transform: scale(1.08);
      box-shadow: 0 12px 48px rgba(255,255,255,0.5), 0 0 80px rgba(255,255,255,0.4);
    }

    .control-btn:active::before {
      width: 500px;
      height: 500px;
    }

    .btn-main {
      font-size: 17px;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-icon {
      font-size: 22px;
      filter: drop-shadow(0 0 8px rgba(255,255,255,0.8));
    }

    .btn-arrow {
      font-size: 16px;
      opacity: 0.85;
    }

    .btn-hint {
      font-size: 11px;
      opacity: 0.8;
      z-index: 1;
      font-weight: normal;
    }

    /* æ¨ã—ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #oshi-btn.aya {
      background: linear-gradient(135deg, var(--aya1) 0%, var(--aya2) 30%, var(--aya3) 60%, var(--aya5) 100%);
      box-shadow: 0 8px 32px var(--aya-glow), 0 0 60px var(--aya-shadow);
    }

    #oshi-btn.koki {
      background: linear-gradient(135deg, var(--koki1) 0%, var(--koki2) 30%, var(--koki3) 60%, var(--koki5) 100%);
      box-shadow: 0 8px 32px var(--koki-glow), 0 0 60px var(--koki-shadow);
    }

    /* ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #mode-btn.gentle {
      background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 50%, #A78BFA 100%);
      box-shadow: 0 8px 32px rgba(139, 92, 246, 0.7), 0 0 60px rgba(167, 139, 250, 0.5);
    }

    #mode-btn.intense {
      background: linear-gradient(135deg, #DC2626 0%, #F59E0B 50%, #FCD34D 100%);
      box-shadow: 0 8px 32px rgba(245, 158, 11, 0.8), 0 0 60px rgba(252, 211, 77, 0.6);
    }

    /* ==================== çµµæ–‡å­—ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« ==================== */
    .emoji-particle {
      position: fixed;
      pointer-events: none;
      z-index: 5;
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
      will-change: transform, opacity;
    }

    /* [2] å‹•ãã«ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŒãŸã›ãŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¾¤ */
    @keyframes float-up {
      0%   { transform: translate(0, 0) scale(1);     opacity: 1; }
      100% { transform: translate(0, -220px) scale(0.7); opacity: 0; }
    }

    @keyframes float-curve-left {
      0%   { transform: translate(0, 0) scale(0.8) rotate(0deg);    opacity: 1; }
      100% { transform: translate(-120px, -260px) scale(1.1) rotate(-25deg); opacity: 0; }
    }

    @keyframes float-curve-right {
      0%   { transform: translate(0, 0) scale(0.8) rotate(0deg);    opacity: 1; }
      100% { transform: translate(120px, -260px) scale(1.1) rotate(25deg);  opacity: 0; }
    }

    @keyframes float-zoom {
      0%   { transform: translate(0, 0) scale(0.4) rotate(0deg);   opacity: 0.9; }
      100% { transform: translate(40px, -320px) scale(1.6) rotate(360deg); opacity: 0; }
    }

    /* ==================== èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ==================== */
    .aya-bg {
      background: linear-gradient(135deg, 
        var(--aya1) 0%,    /* ãƒã‚ªãƒ³ãƒ”ãƒ³ã‚¯ */
        var(--aya2) 25%,   /* ãƒŸãƒ«ã‚­ãƒ¼ãƒ”ãƒ³ã‚¯ */
        var(--aya3) 50%,   /* ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼ */
        var(--aya4) 75%,   /* ã‚½ãƒ•ãƒˆã‚¤ã‚¨ãƒ­ãƒ¼ */
        var(--aya5) 100%   /* é®®ã‚„ã‹ãƒ”ãƒ³ã‚¯ */
      );
      background-size: 400% 400%;
    }

    .koki-bg {
      background: linear-gradient(135deg, 
        var(--koki1) 0%,   /* ãƒ‡ã‚£ãƒ¼ãƒ—ãƒã‚¤ãƒ“ãƒ¼ */
        var(--koki2) 25%,  /* ã‚¯ãƒªã‚¢ãƒ–ãƒ«ãƒ¼ */
        var(--koki3) 50%,  /* ã‚µã‚¤ã‚¢ãƒ³ãƒ©ã‚¤ãƒˆ */
        var(--koki4) 75%,  /* ãƒ‘ãƒ¼ãƒ—ãƒ«ã‚°ãƒªãƒƒãƒ */
        var(--koki5) 100%  /* ãƒ¡ã‚¿ãƒ«ãƒ›ãƒ¯ã‚¤ãƒˆ */
      );
      background-size: 400% 400%;
    }

    /* å„ªã—ã„ãƒ¢ãƒ¼ãƒ‰ï¼šå‘¼å¸ã™ã‚‹å…‰ */
    .animate-bg-gentle {
      animation: gradient-shift-gentle 10s ease-in-out infinite, breathe-light 5s ease-in-out infinite;
      filter: brightness(0.95) saturate(0.9);
    }

    @keyframes gradient-shift-gentle {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes breathe-light {
      0%, 100% { filter: brightness(0.95) saturate(0.9); }
      50% { filter: brightness(1.05) saturate(1); }
    }

    /* æ¿€ã—ã„ãƒ¢ãƒ¼ãƒ‰ï¼šé«˜é€Ÿã‚°ãƒ©ãƒ‡ï¼‹å¼·ã„ç™ºå…‰ */
    .animate-bg-intense {
      animation: gradient-shift-intense 0.3s ease-in-out infinite;
      filter: brightness(1.6) saturate(1.3) contrast(1.2);
    }

    @keyframes gradient-shift-intense {
      0%, 100% { 
        background-position: 0% 50%;
      }
      25% { 
        background-position: 25% 50%;
      }
      50% { 
        background-position: 50% 50%;
      }
      75% { 
        background-position: 75% 50%;
      }
    }

    /* ==================== ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ==================== */
    .flash-effect {
      animation: flash 0.5s ease-out;
    }

    @keyframes flash {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(3.2) saturate(1.5); }
    }

    .rainbow-effect {
      animation: rainbow 1.5s ease-in-out;
    }

    @keyframes rainbow {
      0% { filter: hue-rotate(0deg) brightness(1.5) saturate(1.8); }
      20% { filter: hue-rotate(72deg) brightness(2) saturate(2); }
      40% { filter: hue-rotate(144deg) brightness(2) saturate(2); }
      60% { filter: hue-rotate(216deg) brightness(2) saturate(2); }
      80% { filter: hue-rotate(288deg) brightness(2) saturate(2); }
      100% { filter: hue-rotate(360deg) brightness(1) saturate(1); }
    }

    .pink-burst {
      animation: pink-burst 0.8s ease-out;
    }

    @keyframes pink-burst {
      0% { 
        filter: brightness(1) saturate(1);
        box-shadow: 0 0 0 rgba(255, 20, 147, 0);
      }
      50% { 
        filter: brightness(2.5) saturate(2) hue-rotate(-10deg);
        box-shadow: 0 0 100px rgba(255, 20, 147, 0.8);
      }
      100% { 
        filter: brightness(1) saturate(1);
        box-shadow: 0 0 0 rgba(255, 20, 147, 0);
      }
    }

    .blue-pulse {
      animation: blue-pulse 0.8s ease-out;
    }

    @keyframes blue-pulse {
      0% { 
        filter: brightness(1) saturate(1);
        box-shadow: 0 0 0 rgba(0, 240, 255, 0);
      }
      50% { 
        filter: brightness(2.5) saturate(2) hue-rotate(10deg);
        box-shadow: 0 0 100px rgba(0, 240, 255, 0.8);
      }
      100% { 
        filter: brightness(1) saturate(1);
        box-shadow: 0 0 0 rgba(0, 240, 255, 0);
      }
    }

    .golden-glow {
      animation: golden-glow 1s ease-out;
    }

    @keyframes golden-glow {
      0%, 100% { 
        filter: brightness(1) saturate(1);
      }
      50% { 
        filter: brightness(2.2) saturate(1.8) hue-rotate(30deg);
        box-shadow: 0 0 80px rgba(255, 215, 0, 0.7);
      }
    }

    /* ==================== çŠ¶æ…‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ==================== */
    #status-message {
      position: fixed;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 12px;
      z-index: 15;
      border: 1px solid var(--glass-border);
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
      text-align: center;
      max-width: 85%;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    #status-message.show {
      opacity: 1;
    }

    /* ==================== ãƒã‚¤ã‚¯è¨±å¯ãƒ¢ãƒ¼ãƒ€ãƒ« ==================== */
    #mic-permission-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }

    #mic-permission-modal.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 2px solid var(--glass-border);
      border-radius: 30px;
      padding: 40px 30px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
    }

    .modal-icon {
      font-size: 60px;
      margin-bottom: 20px;
      animation: pulse-icon 2s ease-in-out infinite;
    }

    @keyframes pulse-icon {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .modal-title {
      font-size: 22px;
      font-weight: bold;
      color: white;
      margin-bottom: 15px;
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
    }

    .modal-description {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .modal-btn {
      width: 100%;
      padding: 18px 24px;
      border: none;
      border-radius: 20px;
      font-size: 16px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 28px rgba(0,0,0,0.5);
      margin-bottom: 12px;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, #FF1493 0%, #FF4F81 50%, #FFB7C5 100%);
      border: 2px solid rgba(255, 255, 255, 0.4);
    }

    .modal-btn-primary:active {
      transform: scale(0.98);
      box-shadow: 0 12px 40px rgba(255, 20, 147, 0.6);
    }

    .modal-btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .modal-btn-secondary:active {
      transform: scale(0.98);
      background: rgba(255, 255, 255, 0.15);
    }

    /* ==================== ç¨²å¦»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ==================== */
    .lightning {
      position: fixed;
      width: 5px;
      height: 100%;
      background: linear-gradient(to bottom, 
        transparent, 
        #CFFAFE 20%, 
        #E0E0FF 50%, 
        #CFFAFE 80%, 
        transparent);
      box-shadow: 0 0 30px #CFFAFE, 0 0 60px #00F0FF, 0 0 90px #0059FF;
      opacity: 0;
      z-index: 4;
      pointer-events: none;
      transform-origin: top center;
    }

    @keyframes lightning-flash {
      0%, 100% { opacity: 0; }
      10%, 30%, 50% { opacity: 1; }
      20%, 40% { opacity: 0.5; }
    }

    /* ãƒãƒ¼ãƒˆå½—æ˜Ÿ */
    .heart-comet {
      position: fixed;
      font-size: 40px;
      pointer-events: none;
      z-index: 5;
      filter: drop-shadow(0 0 20px var(--aya-glow)) drop-shadow(0 0 40px var(--aya-shadow));
      animation: comet-fly 1.5s ease-out forwards;
    }

    @keyframes comet-fly {
      0% {
        transform: translate(0, 0) scale(0.5) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translate(350px, -450px) scale(1.8) rotate(360deg);
        opacity: 0;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <!-- ãƒ¡ã‚¤ãƒ³èƒŒæ™¯ã‚¨ãƒªã‚¢ -->
  <div id="light-area" class="aya-bg animate-bg-gentle">
   <canvas id="particles-canvas"></canvas>
   <div id="effects-layer">
    <div class="laser-sweep"></div>
    <div class="spotlight"></div>
   </div>
   <div id="lightning-container"></div>
  </div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header id="header">
   <h1 id="title">âœ¨ Aya and Koki Wedding After Party âœ¨</h1>
   <p id="subtitle">ğŸ¤ ãƒšãƒ³ãƒ©ã‚¤ãƒˆã§ä¸€ç·’ã«ç››ã‚Šä¸ŠãŒã‚ã†! ğŸ¤</p>
  </header>

  <!-- çŠ¶æ…‹è¡¨ç¤ºãƒãƒ¼ -->
  <div id="status-bar">
   <div id="status-text">
    <span class="btn-icon">ğŸ’–</span>
    <span>AYAæ¨ã—</span>
    <span style="opacity: 0.6;">ï½œ</span>
    <span class="btn-icon">ğŸŒ™</span>
    <span>å„ªã—ã„ãƒ¢ãƒ¼ãƒ‰</span>
   </div>
  </div>

  <!-- çŠ¶æ…‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <div id="status-message"></div>

  <!-- ãƒã‚¤ã‚¯è¨±å¯ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="mic-permission-modal" class="show">
   <div class="modal-content">
    <div class="modal-icon">ğŸ¤</div>
    <h2 class="modal-title">éŸ³ã«åå¿œã™ã‚‹ãƒšãƒ³ãƒ©ã‚¤ãƒˆ</h2>
    <p class="modal-description">
      ãƒã‚¤ã‚¯ã‚’è¨±å¯ã™ã‚‹ã¨ã€éŸ³æ¥½ã‚„æ­“å£°ã«åˆã‚ã›ã¦<br>
      ãƒšãƒ³ãƒ©ã‚¤ãƒˆãŒå…‰ã‚Šã¾ã™ï¼âœ¨<br><br>
      <small style="opacity: 0.7;">â€»è¨±å¯ã—ãªãã¦ã‚‚ä½¿ãˆã¾ã™</small>
    </p>
    <button id="allow-mic-btn" class="modal-btn modal-btn-primary"> ğŸµ ãƒã‚¤ã‚¯ã‚’è¨±å¯ã™ã‚‹ </button>
    <button id="skip-mic-btn" class="modal-btn modal-btn-secondary"> å¾Œã§è¨­å®šã™ã‚‹ </button>
   </div>
  </div>

  <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
  <nav id="controls">
    <button id="oshi-btn" class="control-btn aya" aria-label="æ¨ã—ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹">
      <div class="btn-main">
        <span class="btn-icon">ğŸ’–</span>
        <span>AYAæ¨ã—</span>
        <span class="btn-arrow">â†’</span>
        <span class="btn-icon">ğŸ’™</span>
        <span>KOKIæ¨ã—</span>
      </div>
      <div class="btn-hint">æ¨ã—ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™</div>
    </button>

    <button id="mode-btn" class="control-btn gentle" aria-label="ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹">
      <div class="btn-main">
        <span class="btn-icon">ğŸŒ™</span>
        <span>å„ªã—ã„ãƒ¢ãƒ¼ãƒ‰</span>
        <span class="btn-arrow">â†’</span>
        <span class="btn-icon">âš¡</span>
        <span>æ¿€ã—ã</span>
      </div>
      <div class="btn-hint">å…‰ã®å‹•ãã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™</div>
    </button>
  </nav>

  <script src="/_sdk/element_sdk.js"></script>
  <script>

            // ==================== è¨­å®š ====================
    const defaultConfig = {
      oshi: 'aya',
      mode: 'gentle',
      title: 'âœ¨ Aya and Koki Wedding After Party âœ¨',
      subtitle: 'ğŸ¤ ãƒšãƒ³ãƒ©ã‚¤ãƒˆã§ä¸€ç·’ã«ç››ã‚Šä¸ŠãŒã‚ã†! ğŸ¤'
    };

    // ==================== çŠ¶æ…‹ç®¡ç† ====================
    const state = {
      oshi: defaultConfig.oshi,
      mode: defaultConfig.mode,
      audioContext: null,
      analyser: null,
      audioLevel: 0,
      lastShakeTime: 0,
      particles: [],
      isTouching: false,
      lastEmojiTime: 0,      // [1] ã‚¹ãƒ¯ã‚¤ãƒ—æ™‚ã®çµµæ–‡å­—é‡ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
      hasAudioPermission: false,
      hasMotionPermission: false,
      demoMode: false,
      lastActiveTime: Date.now(),
      lastEffectTime: 0
    };

    // ==================== DOMè¦ç´  ====================
    const canvas = document.getElementById('particles-canvas');
    const ctx = canvas.getContext('2d');
    const lightArea = document.getElementById('light-area');
    const effectsLayer = document.getElementById('effects-layer');
    const oshiBtn = document.getElementById('oshi-btn');
    const modeBtn = document.getElementById('mode-btn');
    const statusBar = document.getElementById('status-bar');
    const statusText = document.getElementById('status-text');
    const statusMessage = document.getElementById('status-message');
    const lightningContainer = document.getElementById('lightning-container');
    const micPermissionModal = document.getElementById('mic-permission-modal');
    const allowMicBtn = document.getElementById('allow-mic-btn');
    const skipMicBtn = document.getElementById('skip-mic-btn');

    // ==================== ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®š ====================
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // ==================== ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¯ãƒ©ã‚¹ ====================
    class Particle {
      constructor(x, y, type, oshi) {
        this.x = x;
        this.y = y;
        this.type = type;
        this.oshi = oshi;
        this.life = 1;
        this.baseSpeed = state.mode === 'intense' ? 3.0 : 1.5;
        this.speed = this.baseSpeed;
        this.size = Math.random() * 28 + 22;
        this.vx = (Math.random() - 0.5) * 3;
        this.vy = -Math.random() * 4 - 2;
        this.rotation = Math.random() * Math.PI * 2;
        this.rotationSpeed = (Math.random() - 0.5) * 0.15;
        this.opacity = 1;
      }

      update() {
        const audioBoost = 1 + (state.audioLevel * 2);
        this.speed = this.baseSpeed * audioBoost;

        this.x += this.vx * this.speed;
        this.y += this.vy * this.speed;
        this.life -= state.mode === 'intense' ? 0.018 : 0.01;
        this.rotation += this.rotationSpeed * audioBoost;
        this.opacity = this.life;
      }

      draw() {
        ctx.save();
        ctx.globalAlpha = this.opacity;
        ctx.translate(this.x, this.y);
        ctx.rotate(this.rotation);
        ctx.font = `${this.size}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const glowIntensity = 18 + (state.audioLevel * 26);
        ctx.shadowBlur = glowIntensity;
        ctx.shadowColor = this.oshi === 'aya' ? '#FF1493' : '#00F0FF';

        ctx.fillText(this.type, 0, 0);
        ctx.restore();
      }
    }

    // ==================== ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆ ====================
    function createBackgroundParticles() {
      const audioMultiplier = 1 + (state.audioLevel * 2.5);
      const intenseProbability = 0.16 * audioMultiplier;
      const gentleProbability = 0.035 * audioMultiplier;

      if (state.mode === 'intense' && Math.random() < intenseProbability) {
        const x = Math.random() * canvas.width;
        const y = canvas.height + 20;
        const types = state.oshi === 'aya'
          ? ['ğŸ’–', 'â­', 'âœ¨', 'ğŸŒ¸', 'ğŸ’•', 'ğŸŒº', 'ğŸ€', 'ğŸ’—', 'ğŸŒŸ']
          : ['âš¡', 'ğŸ’™', 'ğŸ”¥', 'âœ¨', 'ğŸ’«', 'ğŸŒŸ', 'ğŸ’', 'ğŸŒ€'];
        const type = types[Math.floor(Math.random() * types.length)];
        state.particles.push(new Particle(x, y, type, state.oshi));
      }

      if (state.mode === 'gentle' && Math.random() < gentleProbability) {
        const x = Math.random() * canvas.width;
        const y = canvas.height + 20;
        const types = state.oshi === 'aya'
          ? ['âœ¨', 'â­', 'ğŸ’–', 'ğŸŒ¸', 'ğŸ’•']
          : ['âœ¨', 'ğŸ’™', 'ğŸ’«', 'ğŸŒŸ', 'ğŸ’'];
        const type = types[Math.floor(Math.random() * types.length)];
        state.particles.push(new Particle(x, y, type, state.oshi));
      }
    }

    // ==================== ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ====================
    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      createBackgroundParticles();

      // éŸ³ãƒ¬ãƒ™ãƒ«ãŒé«˜ã„æ™‚ã€æ´¾æ‰‹ãªæ¼”å‡ºã‚’è¿½åŠ 
      if (state.audioLevel > 0.7 && Math.random() < 0.25) {
        if (state.oshi === 'aya') {
          createHeartComet();
        } else {
          createDiagonalLightning();
        }
      }

      // æ¿€ã—ã„ãƒ¢ãƒ¼ãƒ‰æ™‚ã€ãƒ¬ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
      if (state.mode === 'intense') {
        effectsLayer.classList.add('active');
      } else {
        effectsLayer.classList.remove('active');
      }

      state.particles = state.particles.filter(p => p.life > 0);
      state.particles.forEach(p => {
        p.update();
        p.draw();
      });

      // ã¨ãã©ãèƒŒæ™¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆæ¿€ã—ã„ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
      const now = Date.now();
      if (now - state.lastEffectTime > 3000 && Math.random() < 0.004 && state.mode === 'intense') {
        triggerRandomEffect();
        state.lastEffectTime = now;
      }

      requestAnimationFrame(animateParticles);
    }

    // ==================== ãƒ©ãƒ³ãƒ€ãƒ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ====================
    function triggerRandomEffect() {
      const effects = state.oshi === 'aya'
        ? ['rainbow-effect', 'pink-burst', 'golden-glow']
        : ['rainbow-effect', 'blue-pulse', 'golden-glow'];

      const effect = effects[Math.floor(Math.random() * effects.length)];
      lightArea.classList.add(effect);
      setTimeout(() => lightArea.classList.remove(effect), effect === 'rainbow-effect' ? 1500 : 800);
    }

    // ãƒãƒ¼ãƒˆå½—æ˜Ÿ
    function createHeartComet() {
      const comet = document.createElement('div');
      comet.className = 'heart-comet';
      comet.textContent = 'ğŸ’–';
      comet.style.left = (Math.random() * 50) + '%';
      comet.style.top = (Math.random() * 30 + 55) + '%';
      document.body.appendChild(comet);
      setTimeout(() => comet.remove(), 1500);
    }

    // æ–œã‚ç¨²å¦»
    function createDiagonalLightning() {
      const lightning = document.createElement('div');
      lightning.className = 'lightning';
      const angle = Math.random() * 60 - 30;
      lightning.style.left = Math.random() * 100 + '%';
      lightning.style.transform = `rotate(${angle}deg)`;
      lightning.style.animation = 'lightning-flash 0.45s ease-out';
      lightningContainer.appendChild(lightning);
      setTimeout(() => lightning.remove(), 500);
    }

    // ==================== UIæ›´æ–°ï¼ˆæŠ¼ã—ï¼ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆåæ˜ ï¼‰ [5] ====================
    function updateUI() {
      let config;

      if (window.elementSdk && window.elementSdk.config) {
        config = window.elementSdk.config;
      } else {
        // GitHub Pages ãªã©é€šå¸¸ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ï¼šstate ã®å€¤ã‚’å„ªå…ˆ
        config = {
          ...defaultConfig,
          oshi: state.oshi,
          mode: state.mode
        };
      }

      document.getElementById('title').textContent = config.title;
      document.getElementById('subtitle').textContent = config.subtitle;

      // èƒŒæ™¯ã‚¯ãƒ©ã‚¹ã®æ›´æ–°ï¼ˆæ—¢å­˜ã‚¯ãƒ©ã‚¹ã‚’å¤–ã—ã¦ã‹ã‚‰ä»˜ã‘ç›´ã™ï¼‰
      lightArea.classList.remove('aya-bg', 'koki-bg', 'animate-bg-gentle', 'animate-bg-intense');
      if (config.oshi === 'aya') {
        lightArea.classList.add('aya-bg');
      } else {
        lightArea.classList.add('koki-bg');
      }
      if (config.mode === 'intense') {
        lightArea.classList.add('animate-bg-intense');
      } else {
        lightArea.classList.add('animate-bg-gentle');
      }

      // æ¨ã—ãƒœã‚¿ãƒ³ã®æ›´æ–°
      oshiBtn.classList.remove('aya', 'koki');
      if (config.oshi === 'aya') {
        oshiBtn.classList.add('aya');
        oshiBtn.querySelector('.btn-main').innerHTML = `
          <span class="btn-icon">ğŸ’–</span>
          <span>AYAæ¨ã—</span>
          <span class="btn-arrow">â†’</span>
          <span class="btn-icon">ğŸ’™</span>
          <span>KOKIæ¨ã—</span>
        `;
      } else {
        oshiBtn.classList.add('koki');
        oshiBtn.querySelector('.btn-main').innerHTML = `
          <span class="btn-icon">ğŸ’™</span>
          <span>KOKIæ¨ã—</span>
          <span class="btn-arrow">â†’</span>
          <span class="btn-icon">ğŸ’–</span>
          <span>AYAæ¨ã—</span>
        `;
      }

      // ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®æ›´æ–°
      modeBtn.classList.remove('gentle', 'intense');
      if (config.mode === 'intense') {
        modeBtn.classList.add('intense');
        modeBtn.querySelector('.btn-main').innerHTML = `
          <span class="btn-icon">âš¡</span>
          <span>æ¿€ã—ã„ãƒ¢ãƒ¼ãƒ‰</span>
          <span class="btn-arrow">â†’</span>
          <span class="btn-icon">ğŸŒ™</span>
          <span>å„ªã—ã</span>
        `;
      } else {
        modeBtn.classList.add('gentle');
        modeBtn.querySelector('.btn-main').innerHTML = `
          <span class="btn-icon">ğŸŒ™</span>
          <span>å„ªã—ã„ãƒ¢ãƒ¼ãƒ‰</span>
          <span class="btn-arrow">â†’</span>
          <span class="btn-icon">âš¡</span>
          <span>æ¿€ã—ã</span>
        `;
      }

      // çŠ¶æ…‹ãƒãƒ¼ã®æ›´æ–°
      const oshiIcon = config.oshi === 'aya' ? 'ğŸ’–' : 'ğŸ’™';
      const oshiText = config.oshi === 'aya' ? 'AYAæ¨ã—' : 'KOKIæ¨ã—';
      const modeIcon = config.mode === 'intense' ? 'âš¡' : 'ğŸŒ™';
      const modeText = config.mode === 'intense' ? 'æ¿€ã—ã„ãƒ¢ãƒ¼ãƒ‰' : 'å„ªã—ã„ãƒ¢ãƒ¼ãƒ‰';

      statusText.innerHTML = `
        <span class="btn-icon">${oshiIcon}</span>
        <span>${oshiText}</span>
        <span style="opacity: 0.6;">ï½œ</span>
        <span class="btn-icon">${modeIcon}</span>
        <span>${modeText}</span>
      `;

      state.oshi = config.oshi;
      state.mode = config.mode;

      if (config.oshi === 'koki' && config.mode === 'intense') {
        startLightningEffect();
      }
    }

    // ==================== ç¨²å¦»ãƒ«ãƒ¼ãƒ— ====================
    function startLightningEffect() {
      if (state.oshi === 'koki' && state.mode === 'intense') {
        if (Math.random() < 0.15) {
          createDiagonalLightning();
        }
        setTimeout(startLightningEffect, Math.random() * 1200 + 600);
      }
    }

    // ==================== ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•° ====================
    function triggerFlashEffect() {
      lightArea.classList.add('flash-effect');
      setTimeout(() => lightArea.classList.remove('flash-effect'), 500);
    }

    function triggerRainbowEffect() {
      lightArea.classList.add('rainbow-effect');
      setTimeout(() => lightArea.classList.remove('rainbow-effect'), 1500);
    }

    function showStatusMessage(message, duration = 5000) {
      statusMessage.textContent = message;
      statusMessage.classList.add('show');
      setTimeout(() => statusMessage.classList.remove('show'), duration);
    }


            // ==================== ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ ====================
    oshiBtn.addEventListener('click', () => {
      const newOshi = state.oshi === 'aya' ? 'koki' : 'aya';
      if (window.elementSdk && window.elementSdk.setConfig) {
        window.elementSdk.setConfig({ oshi: newOshi });
      } else {
        state.oshi = newOshi;
        updateUI();
      }
      triggerRainbowEffect();
      state.lastActiveTime = Date.now();
    });

    modeBtn.addEventListener('click', () => {
      const newMode = state.mode === 'gentle' ? 'intense' : 'gentle';
      if (window.elementSdk && window.elementSdk.setConfig) {
        window.elementSdk.setConfig({ mode: newMode });
      } else {
        state.mode = newMode;
        updateUI();
      }
      triggerFlashEffect();
      state.lastActiveTime = Date.now();
    });

    // ==================== ã‚¿ãƒƒãƒ—ï¼ã‚¹ãƒ¯ã‚¤ãƒ—ã§çµµæ–‡å­—ç”Ÿæˆ [1][2] ====================
    function createEmojiParticles(x, y, options = {}) {
      const {
        baseCount = 4,
        maxExtra = 2
      } = options;

      const emojis = state.oshi === 'aya'
        ? ['ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ’–', 'ğŸ’•', 'ğŸ’—', 'ğŸ’“', 'ğŸ’', 'â­', 'âœ¨', 'ğŸŒ¸', 'ğŸŒº', 'ğŸ€', 'ğŸ‘°', 'ğŸ’', 'ğŸ¦‹']
        : ['ğŸ˜', 'ğŸ¤©', 'ğŸ˜¤', 'ğŸ”¥', 'âš¡', 'ğŸ’™', 'ğŸ’', 'âœ¨', 'ğŸ’«', 'ğŸŒŸ', 'ğŸ’ª', 'ğŸ¸', 'ğŸ¤˜', 'ğŸ‘”', 'ğŸ©'];

      const total = baseCount + Math.floor(Math.random() * (maxExtra + 1));

      for (let i = 0; i < total; i++) {
        const emoji = emojis[Math.floor(Math.random() * emojis.length)];
        const particle = document.createElement('div');
        particle.className = 'emoji-particle';
        particle.textContent = emoji;

        const size = Math.floor(Math.random() * 24) + 24;
        particle.style.fontSize = size + 'px';

        const offsetX = (Math.random() - 0.5) * 80;
        const offsetY = (Math.random() - 0.5) * 80;
        particle.style.left = (x + offsetX) + 'px';
        particle.style.top = (y + offsetY) + 'px';

        // [2] å‹•ãã‚’ãƒ©ãƒ³ãƒ€ãƒ ã§å¤‰ãˆã‚‹
        const animations = ['float-up', 'float-curve-left', 'float-curve-right', 'float-zoom'];
        const ani = animations[Math.floor(Math.random() * animations.length)];
        const duration = (Math.random() * 0.8 + 1.6).toFixed(2); // 1.6ã€œ2.4ç§’
        particle.style.animation = `${ani} ${duration}s ease-out forwards`;

        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 2600);
      }
    }

    // ã‚¿ãƒƒãƒ—ï¼ˆ1å›ãƒ‰ãƒ³ï¼ï¼‰
    lightArea.addEventListener('click', (e) => {
      createEmojiParticles(e.clientX, e.clientY, { baseCount: 5, maxExtra: 3 });
      state.lastActiveTime = Date.now();
    });

    // ã‚¿ãƒƒãƒï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—æ™‚ã¯æ§ãˆã‚ï¼‹ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰ [1]
    lightArea.addEventListener('touchstart', (e) => {
      e.preventDefault();
      state.isTouching = true;
      const touch = e.touches[0];
      createEmojiParticles(touch.clientX, touch.clientY, { baseCount: 4, maxExtra: 2 });
      state.lastEmojiTime = Date.now();
      state.lastActiveTime = Date.now();
    }, { passive: false });

    lightArea.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (!state.isTouching) return;
      const touch = e.touches[0];
      const now = Date.now();
      const cooldown = 90; // msï¼šã“ã‚Œã‚ˆã‚ŠçŸ­ã„é–“éš”ã§ã¯çµµæ–‡å­—ã‚’å‡ºã•ãªã„

      if (now - state.lastEmojiTime > cooldown) {
        createEmojiParticles(touch.clientX, touch.clientY, { baseCount: 2, maxExtra: 1 });
        state.lastEmojiTime = now;
        state.lastActiveTime = now;
      }
    }, { passive: false });

    lightArea.addEventListener('touchend', () => {
      state.isTouching = false;
    });

    // ==================== æŒ¯å‹•æ¤œå‡ºï¼ˆã‚·ã‚§ã‚¤ã‚¯æ¼”å‡ºå¼·åŒ–ï¼‰ [4] ====================
    function handleShake(event) {
      const acc = event.accelerationIncludingGravity;
      if (!acc) return;

      const magnitude = Math.sqrt(acc.x ** 2 + acc.y ** 2 + acc.z ** 2);
      const threshold = state.mode === 'intense' ? 11 : 16;

      const now = Date.now();
      if (magnitude > threshold && now - state.lastShakeTime > 350) {
        state.lastShakeTime = now;

        // ã‚·ã‚§ã‚¤ã‚¯æ™‚ã®å¼·ã„ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
        const intensity = state.mode === 'intense' ? 3.0 : 2.1;
        const audioBoost = 1 + (state.audioLevel * 0.7);
        lightArea.style.filter = `brightness(${intensity * audioBoost}) saturate(1.7)`;
        setTimeout(() => {
          lightArea.style.filter = '';
        }, 220);

        // è¿½åŠ æ¼”å‡º
        if (state.oshi === 'aya') {
          createHeartComet();
        } else {
          createDiagonalLightning();
        }
        triggerRandomEffect();

        state.hasMotionPermission = true;
        state.lastActiveTime = now;
      }
    }

    if (window.DeviceMotionEvent) {
      window.addEventListener('devicemotion', handleShake);
    }

    // ==================== éŸ³å£°ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ï¼ˆéŸ³ã«åˆã‚ã›ãŸå…‰ï¼‰ [3] ====================
    function startAudioVisualizer() {
      function checkAudio() {
        if (!state.analyser) return;

        const dataArray = new Uint8Array(state.analyser.frequencyBinCount);
        state.analyser.getByteFrequencyData(dataArray);
        const average = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
        state.audioLevel = average / 255;

        // éŸ³ã«åˆã‚ã›ã¦æ˜ã‚‹ã•ã¨å½©åº¦ã‚’ä¸Šã’ã‚‹
        const baseBrightness = state.mode === 'intense' ? 1.4 : 1.0;
        const audioBrightness = state.audioLevel * (state.mode === 'intense' ? 1.6 : 0.7);
        const brightness = baseBrightness + audioBrightness;
        const saturation = 1 + state.audioLevel * 0.8;

        lightArea.style.filter = `brightness(${brightness}) saturate(${saturation})`;

        // ä¸€å®šä»¥ä¸Šã®éŸ³ã§è¿½åŠ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        if (state.audioLevel > 0.65 && Math.random() < 0.15) {
          triggerRandomEffect();
        }

        requestAnimationFrame(checkAudio);
      }
      checkAudio();
    }

    // ==================== ãƒã‚¤ã‚¯è¨±å¯ã‚¤ãƒ™ãƒ³ãƒˆ ====================
    allowMicBtn.addEventListener('click', async () => {
      allowMicBtn.textContent = 'æ¥ç¶šä¸­...';
      allowMicBtn.disabled = true;

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        state.analyser = state.audioContext.createAnalyser();
        const source = state.audioContext.createMediaStreamSource(stream);
        source.connect(state.analyser);
        state.analyser.fftSize = 256;
        state.hasAudioPermission = true;

        micPermissionModal.classList.remove('show');
        showStatusMessage('ğŸ¤ ãƒã‚¤ã‚¯æ¥ç¶šå®Œäº†ï¼éŸ³ã«åå¿œã—ã¾ã™', 3000);
        startAudioVisualizer();
      } catch (err) {
        console.error('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', err);
        state.hasAudioPermission = false;
        state.demoMode = true;
        micPermissionModal.classList.remove('show');
        showStatusMessage('âš ï¸ ãƒã‚¤ã‚¯ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã™', 4000);
        startDemoMode();
      }
    });

    skipMicBtn.addEventListener('click', () => {
      micPermissionModal.classList.remove('show');
      state.demoMode = true;
      showStatusMessage('ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã—ãŸ', 3000);
      startDemoMode();
    });
      // ==================== ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒã‚¤ã‚¯ç„¡ã—ç”¨ï¼‰ ====================
    function startDemoMode() {
      // 2é‡èµ·å‹•ã—ã¦ã‚‚å®³ã¯å°‘ãªã„ãŒã€å¿µã®ãŸã‚ä¸€åº¦ã ã‘ã«ã—ãŸã„å ´åˆã¯ãƒ•ãƒ©ã‚°è¿½åŠ ã‚‚å¯
      setInterval(() => {
        state.audioLevel = Math.random() * 0.7 + 0.2;

        const baseBrightness = state.mode === 'intense' ? 1.4 : 1.0;
        const audioBrightness = state.audioLevel * (state.mode === 'intense' ? 1.3 : 0.6);
        const brightness = baseBrightness + audioBrightness;
        const saturation = 1 + state.audioLevel * 0.6;

        lightArea.style.filter = `brightness(${brightness}) saturate(${saturation})`;

        if (Math.random() < 0.08) {
          if (state.oshi === 'aya') {
            createHeartComet();
          } else {
            createDiagonalLightning();
          }
        }
      }, 220);
    }

    // ==================== ç”»é¢æš—è»¢é˜²æ­¢ ====================
    function preventScreenDimming() {
      setInterval(() => {
        const now = Date.now();
        if (now - state.lastActiveTime > 25000) {
          lightArea.style.filter = 'brightness(1.08)';
          setTimeout(() => {
            lightArea.style.filter = '';
          }, 120);
          state.lastActiveTime = now;
        }
      }, 30000);
    }

    // ==================== åˆæœŸåŒ–å‡¦ç† ====================
    animateParticles();
    preventScreenDimming();

    if (window.elementSdk && window.elementSdk.init) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async () => {
          updateUI();
        },
        mapToCapabilities: () => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['title', config.title],
          ['subtitle', config.subtitle]
        ])
      });
    }

    updateUI();
  </script>
 </body>
</html>
